@{
    Layout = "~/Views/Shared/_DoctorNurseLayout.cshtml";
    ViewData["Title"] = "Chat";
}

<style>
    #currentuser {
        background-color: aquamarine;
        margin-left: 60%;
        width: 40%;
        padding: 10px;
        border-radius: 5px;
        text-align: left;
    }

    #prevoususer {
        background-color: #e0bbff;
        margin-left: 0%;
        width: 40%;
        padding: 10px;
        border-radius: 5px;
        text-align: left;
    }

    .chat-messages {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        background-color: #f9f9f9;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s;
        height: 300px;
        overflow-y: auto;
    }

    .chat-input {
        position: relative;
    }

        .chat-input textarea {
            resize: none;
            border-radius: 5px 0 0 5px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

    .input-group .btn {
        border-radius: 0 5px 5px 0;
    }

    .chat-messages:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .message {
        margin-bottom: 10px;
    }

        .message strong {
            display: block;
        }
</style>

<div class="container mt-4">
    <h3 class="text-center">Chat</h3>

    <div id="chatMessages" class="chat-messages"></div>

    <div class="chat-input mt-3">
        <textarea id="messageText" class="form-control" placeholder="Type your message here..." rows="3"></textarea>
        <button class="btn btn-primary mt-2" onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    function loadMessages() {
        fetch("/GetDoctorNurseChatMessages")
            .then(response => response.json())
            .then(messages => {
                const chatMessages = document.getElementById("chatMessages");
                const currentUserFullName = localStorage.getItem("FullName");

                chatMessages.innerHTML = messages.map(msg => {
                    const isCurrentUser = msg.fullName === currentUserFullName;

                    return `
                                    <div class="message">
                                        ${isCurrentUser ? `
                                            <div id="currentuser">
                                                <strong>${msg.fullName}</strong>
                                                <div>${msg.message}</div>
                                                <span class="text-muted">${new Date(msg.date).toLocaleString()}</span>
                                            </div>
                                        ` : `
                                            <div id="prevoususer">
                                                <strong>${msg.fullName}</strong>
                                                <div>${msg.message}</div>
                                                <span class="text-muted">${new Date(msg.date).toLocaleString()}</span>
                                            </div>
                                        `}
                                    </div>
                                `;
                }).join("");
            })
            .catch(error => console.error("Error loading messages:", error));
    }

    function sendMessage() {
        const messageText = document.getElementById("messageText").value;
        if (!messageText) return;

        const userId = localStorage.getItem("UserId");
        const fullName = localStorage.getItem("FullName");

        fetch("/SaveDoctorNurseMessage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId: userId,
                fullName: fullName,
                message: messageText,
                date: new Date().toISOString()
            })
        })
            .then(response => {
                if (!response.ok) throw new Error("Failed to save message");
                document.getElementById("messageText").value = "";
                loadMessages();
            })
            .catch(error => console.error("Error sending message:", error));
    }

    loadMessages();
</script>
